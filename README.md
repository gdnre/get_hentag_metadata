# get_hentag_metadata
自动压缩漫画文件，从hentag网站获取元数据分类漫画压缩包

## 功能
* 根据文件名在hentag网站搜索漫画信息（hentag id，标题，作者，团队，tag）
* 自动将没有打包的漫画文件夹压缩到设定的漫画库文件夹，没有打包的漫画文件夹指漫画图片文件夹
* 根据搜索到的漫画作者、团队为漫画压缩包创建子文件夹分类，优先使用作者名，使用硬链接进行分类
* 根据hentag id，下载漫画的hentag元数据
* 将hentag元数据输出到漫画名文件夹

## 已知问题
1. 因为用的硬链接，因此分类文件夹要和漫画库在同一磁盘分区（linux上没测试），此外，使用winrar等软件修改压缩包内容后，可能相当于新建了一个压缩文件，使硬链接失效，修改压缩包内容后务必谨慎删除文件；
1. windows系统不支持过长的文件名，有些地方处理了，有些地方没处理；
2. 系统使用编码不同可能会导致文件(夹)名乱码或者导致脚本执行时路径访问错误，实际遇到了再针对性处理；

## 如何使用
首先需要安装python3(废话)，然后安装requests，用pip装的话：
```
pip install request
```
修改脚本文件夹中的config.ini文件，之后运行脚本，看输出的提示操作即可：
```
python3 脚本文件夹/脚本.py
```

## 推荐设置的漫画目录结构
### 未压缩的漫画文件夹，以绿e下载文件为例：
脚本处理逻辑是将目录下(没有子文件夹，没有.zip.rar.7z为后缀的文件)的视作漫画文件夹，以该文件夹名作为漫画名创建压缩包放到漫画库
```
|——downloads
    |
    |——1234567-漫画名1      #绿e下载的文件夹前面带id，脚本处理时会匹配后去掉
    |   |——1.png
    |   |——2.png
    |   -——3.png
    |——2345678-漫画名2
    |   |——1.jpg
    |   
    ....
```
### 漫画库文件夹
漫画压缩包存放的文件夹。
漫画压缩后会放到这里，把全部漫画堆到一起也没关系，脚本会读取这个文件夹及其子文件内的所有.zip.rar.7z为后缀的文件，用文件的前51200B字节数据计算sha1码作为文件的唯一标识id（和lanraragi保持一致）将文件id、路径、文件名存放到数据库里；

因此该文件夹下请不要有非漫画的压缩文件。
```
|——manga_library
    |——漫画1.zip
    |——漫画2.zip
    |——漫画3.zip
```

### 漫画分类文件夹，以放到lanraragi的库下为例
创建漫画压缩包硬链接到这个文件夹达成分类的目的，硬链接理论上不额外占用空间，删除后只要源文件还在，文件就还在，因此可以随意处置；
但绝对不建议在这个文件夹修改压缩包内容，请修改漫画库中的压缩包，然后重新创建硬链接，防止数据丢失。
```
|——lanraragi
    |
    |——content              #你要设置的漫画分类文件夹，也可能是lanraragi扫描的目录
        |——hentag           #脚本自动创建的一个分类根目录
            |——artist       #以作者名分类的漫画在这里      
            |——group        #以团队名分类的漫画在这里，没有作者名时才会放到这里
            |——unsorted     #既没有作者名也没有团队名的漫画放到这里
```
## 其它
本来从hentag下载的元数据应该放到压缩包里供lanraragi直接读的，但python里的压缩模块会导致文件名里的汉字编码错误，不能用现成的方法把文件加到压缩包里，得手动(脚本动)解压缩再重新打包，理论上在压缩前先获取元数据，然后一起打包就解决了，但一开始没想整这功能，懒得改了，元数据都放到以漫画文件名命名的子文件夹里了，有需求的可以真手动解压后，合并文件夹再压缩回去（或者winrar可能可以合并同名压缩文件，没试过）。
还有一个迂回方法，先备份lanraragi数据库，导出，根据元数据改备份文件，再导入回去，这功能之后再整吧。
